# Core Module

> **TL;DR**: Shared infrastructure including UI components, utilities, and Tauri command wrappers used across the application.

## Overview

The `core` module provides foundational building blocks shared by the `worktrees` and `agent-manager` modules:

- **UI Components**: shadcn/ui components (Radix UI + Tailwind CSS)
- **Library Utilities**: CSS class utilities, Tauri command wrappers
- **Core Components**: Header, SettingsDialog, ThemeToggle

## File Structure

```
core/
├── ui/                    # shadcn/ui components (14 files)
│   ├── button.tsx
│   ├── card.tsx
│   ├── dialog.tsx
│   ├── dropdown-menu.tsx
│   ├── input.tsx
│   ├── label.tsx
│   ├── scroll-area.tsx
│   ├── select.tsx
│   ├── separator.tsx
│   ├── switch.tsx
│   ├── textarea.tsx
│   ├── tooltip.tsx
│   ├── app-icon.tsx       # Application icon display
│   ├── markdown-renderer.tsx # Markdown content rendering
│   └── index.ts
├── lib/
│   ├── utils.ts           # cn() utility for class merging
│   ├── commands.ts        # Tauri command wrappers
│   └── index.ts
├── components/
│   ├── header.tsx         # App header with navigation
│   ├── settings-dialog.tsx # Application settings
│   ├── theme-toggle.tsx   # Light/dark/system theme toggle
│   └── index.ts
├── index.ts               # Public exports
└── README.md              # This file
```

## Usage

### Importing from Core

```typescript
// UI components
import { Button, Card, Dialog } from '@core/ui';

// Utilities
import { cn } from '@core/lib';

// Components
import { Header, SettingsDialog, ThemeToggle } from '@core/components';

// Or import everything from the module
import { Button, cn, Header } from '@core';
```

## UI Components

All UI components are pre-configured shadcn/ui components built on Radix UI primitives with Tailwind CSS styling.

| Component | Purpose | Import |
|-----------|---------|--------|
| `Button` | Action buttons with variants | `@core/ui` |
| `Card` | Container cards | `@core/ui` |
| `Dialog` | Modal dialogs | `@core/ui` |
| `DropdownMenu` | Context/dropdown menus | `@core/ui` |
| `Input` | Text input fields | `@core/ui` |
| `Label` | Form labels | `@core/ui` |
| `ScrollArea` | Scrollable containers | `@core/ui` |
| `Select` | Dropdown selects | `@core/ui` |
| `Separator` | Visual dividers | `@core/ui` |
| `Switch` | Toggle switches | `@core/ui` |
| `Textarea` | Multi-line text inputs | `@core/ui` |
| `Tooltip` | Hover tooltips | `@core/ui` |
| `AppIcon` | Application icons | `@core/ui` |
| `MarkdownRenderer` | Markdown content display | `@core/ui` |

### UI Component Notes

- **Do not modify** these components directly; they are generated by shadcn/ui
- Customize using Tailwind CSS classes via the `className` prop
- Use the `cn()` utility for conditional class merging

## Library Utilities

### `cn()` - Class Name Utility

Merges Tailwind CSS classes with proper precedence handling.

```typescript
import { cn } from '@core/lib';

// Basic usage
<div className={cn('base-class', 'additional-class')} />

// Conditional classes
<div className={cn('base', isActive && 'active', isDisabled && 'opacity-50')} />

// Override classes
<div className={cn('p-4 bg-red-500', 'bg-blue-500')} /> // Results in bg-blue-500
```

### `commands.ts` - Tauri Commands

Type-safe wrappers for all Tauri backend commands.

#### Repository Commands

```typescript
import * as commands from '@core/lib/commands';

// List repositories
const repos = await commands.getRepositories();

// Add repository
const repo = await commands.addRepository('/path/to/repo');

// Remove repository
await commands.removeRepository(repoId);

// Refresh repository
const updated = await commands.refreshRepository(repoId);
```

#### Worktree Commands

```typescript
// List worktrees
const worktrees = await commands.listWorktrees(repoPath);

// Create worktree
const worktree = await commands.createWorktree(
  repoPath,
  'feature-x',
  'feature-branch',  // branch (optional)
  undefined,         // commit (optional)
  '#!/bin/bash\nnpm install',  // startup script
  true               // execute script
);

// Remove worktree
await commands.removeWorktree(path, force, deleteBranch);

// Rename worktree
const renamed = await commands.renameWorktree(oldPath, newName);

// Lock/unlock worktree
await commands.lockWorktree(path, reason);
await commands.unlockWorktree(path);
```

#### External App Commands

```typescript
// Open in terminal
await commands.openInTerminal(path, 'ghostty');
await commands.openInTerminal(path, 'custom', 'wezterm start --cwd $PATH');

// Open in editor
await commands.openInEditor(path, 'vscode');
await commands.openInEditor(path, 'custom', 'nvim $PATH');

// System operations
await commands.revealInFinder(path);
await commands.copyToClipboard(text);
```

#### Task Manager Commands

```typescript
// Create task with multiple agents
const task = await commands.createTask(
  'Fix bug',
  'branch',
  'main',
  undefined,
  '/path/to/repo',
  'coder',
  [
    { providerId: 'anthropic', modelId: 'claude-sonnet-4' },
    { providerId: 'openai', modelId: 'gpt-4o' },
  ]
);

// CRUD operations
const tasks = await commands.getTasks();
const task = await commands.getTask(taskId);
await commands.updateTask(taskId, newName, newStatus);
await commands.deleteTask(taskId, deleteWorktrees);
```

#### Agent Commands

```typescript
// Agent management
await commands.addAgentToTask(taskId, modelId, providerId, agentType);
await commands.removeAgentFromTask(taskId, agentId, deleteWorktree);
await commands.updateAgentStatus(taskId, agentId, 'running');
await commands.acceptAgent(taskId, agentId);
await commands.cleanupUnacceptedAgents(taskId);

// OpenCode server management
const port = await commands.startAgentOpencode(taskId, agentId);
await commands.stopAgentOpencode(taskId, agentId);
const port = await commands.getAgentOpencodePort(taskId, agentId);
```

## Core Components

### `Header`

Application header with navigation tabs and settings.

```typescript
import { Header } from '@core/components';

<Header
  activeTab={activeTab}
  onTabChange={setActiveTab}
/>
```

### `SettingsDialog`

Application settings modal for theme, terminal, and editor preferences.

```typescript
import { SettingsDialog } from '@core/components';

<SettingsDialog
  open={settingsOpen}
  onOpenChange={setSettingsOpen}
/>
```

### `ThemeToggle`

Toggle between light, dark, and system themes.

```typescript
import { ThemeToggle } from '@core/components';

<ThemeToggle />
```

## Theming

The application supports three theme modes configured via CSS variables in `src/index.css`:

| Theme | Description |
|-------|-------------|
| `light` | Light color scheme |
| `dark` | Dark color scheme |
| `system` | Follows OS preference |

Theme is persisted in the Zustand store and applied via the `dark` class on `<html>`.

## Adding New UI Components

To add a new shadcn/ui component:

1. Generate the component: `npx shadcn@latest add [component]`
2. Move from `src/components/ui/` to `src/modules/core/ui/`
3. Export from `src/modules/core/ui/index.ts`

## Error Handling

All Tauri commands throw on error. Use try/catch:

```typescript
try {
  await commands.createWorktree(...);
} catch (error) {
  console.error('Failed to create worktree:', error);
  // error is a string from the Rust backend
}
```
