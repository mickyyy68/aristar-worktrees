# Core Module

> **TL;DR**: Shared infrastructure including UI components, utilities, and Tauri command wrappers used across the application.

## Overview

The `core` module provides foundational building blocks shared by the `worktrees` and `agent-manager` modules:

- **UI Components**: shadcn/ui components (Radix UI + Tailwind CSS)
- **Library Utilities**: CSS class utilities, Tauri command wrappers
- **Core Components**: Header, SettingsDialog, ThemeToggle

## File Structure

```
core/
├── ui/                    # shadcn/ui components (14 files)
│   ├── button.tsx
│   ├── card.tsx
│   ├── dialog.tsx
│   ├── dropdown-menu.tsx
│   ├── input.tsx
│   ├── label.tsx
│   ├── scroll-area.tsx
│   ├── select.tsx
│   ├── separator.tsx
│   ├── switch.tsx
│   ├── textarea.tsx
│   ├── tooltip.tsx
│   ├── app-icon.tsx       # Application icon display
│   ├── markdown-renderer.tsx # Markdown content rendering
│   └── index.ts
├── lib/
│   ├── utils.ts           # cn() utility for class merging
│   ├── commands.ts        # Tauri command wrappers
│   ├── themes/            # Theme definitions
│   │   ├── index.ts       # Theme registry and helpers
│   │   ├── aristar.ts     # Aristar theme (default)
│   │   ├── claude.ts      # Claude-inspired theme
│   │   ├── vercel.ts      # Vercel-inspired theme
│   │   └── nature.ts      # Nature-inspired theme
│   └── index.ts
├── hooks/
│   ├── use-theme.ts       # Theme management hook
│   └── index.ts
├── components/
│   ├── header.tsx         # App header with navigation
│   ├── settings-dialog.tsx # Application settings
│   ├── theme-toggle.tsx   # Light/dark/system theme toggle
│   ├── theme-preview.tsx  # Theme color preview card
│   ├── theme-selector.tsx # Theme dropdown selector
│   ├── color-scheme-toggle.tsx # Light/dark/system toggle
│   └── index.ts
├── index.ts               # Public exports
└── README.md              # This file
```

## Usage

### Importing from Core

```typescript
// UI components
import { Button, Card, Dialog } from '@core/ui';

// Utilities
import { cn } from '@core/lib';

// Components
import { Header, SettingsDialog, ThemeToggle } from '@core/components';

// Or import everything from the module
import { Button, cn, Header } from '@core';
```

## UI Components

All UI components are pre-configured shadcn/ui components built on Radix UI primitives with Tailwind CSS styling.

| Component | Purpose | Import |
|-----------|---------|--------|
| `Button` | Action buttons with variants | `@core/ui` |
| `Card` | Container cards | `@core/ui` |
| `Dialog` | Modal dialogs | `@core/ui` |
| `DropdownMenu` | Context/dropdown menus | `@core/ui` |
| `Input` | Text input fields | `@core/ui` |
| `Label` | Form labels | `@core/ui` |
| `ScrollArea` | Scrollable containers | `@core/ui` |
| `Select` | Dropdown selects | `@core/ui` |
| `Separator` | Visual dividers | `@core/ui` |
| `Switch` | Toggle switches | `@core/ui` |
| `Textarea` | Multi-line text inputs | `@core/ui` |
| `Tooltip` | Hover tooltips | `@core/ui` |
| `AppIcon` | Application icons | `@core/ui` |
| `MarkdownRenderer` | Markdown content display | `@core/ui` |

### UI Component Notes

- **Do not modify** these components directly; they are generated by shadcn/ui
- Customize using Tailwind CSS classes via the `className` prop
- Use the `cn()` utility for conditional class merging

## Library Utilities

### `cn()` - Class Name Utility

Merges Tailwind CSS classes with proper precedence handling.

```typescript
import { cn } from '@core/lib';

// Basic usage
<div className={cn('base-class', 'additional-class')} />

// Conditional classes
<div className={cn('base', isActive && 'active', isDisabled && 'opacity-50')} />

// Override classes
<div className={cn('p-4 bg-red-500', 'bg-blue-500')} /> // Results in bg-blue-500
```

### `commands.ts` - Tauri Commands

Type-safe wrappers for all Tauri backend commands.

#### Repository Commands

```typescript
import * as commands from '@core/lib/commands';

// List repositories
const repos = await commands.getRepositories();

// Add repository
const repo = await commands.addRepository('/path/to/repo');

// Remove repository
await commands.removeRepository(repoId);

// Refresh repository
const updated = await commands.refreshRepository(repoId);
```

#### Worktree Commands

```typescript
// List worktrees
const worktrees = await commands.listWorktrees(repoPath);

// Create worktree
const worktree = await commands.createWorktree(
  repoPath,
  'feature-x',
  'feature-branch',  // branch (optional)
  undefined,         // commit (optional)
  '#!/bin/bash\nnpm install',  // startup script
  true               // execute script
);

// Remove worktree
await commands.removeWorktree(path, force, deleteBranch);

// Rename worktree
const renamed = await commands.renameWorktree(oldPath, newName);

// Lock/unlock worktree
await commands.lockWorktree(path, reason);
await commands.unlockWorktree(path);
```

#### External App Commands

```typescript
// Open in terminal
await commands.openInTerminal(path, 'ghostty');
await commands.openInTerminal(path, 'custom', 'wezterm start --cwd $PATH');

// Open in editor
await commands.openInEditor(path, 'vscode');
await commands.openInEditor(path, 'custom', 'nvim $PATH');

// System operations
await commands.revealInFinder(path);
await commands.copyToClipboard(text);
```

#### Task Manager Commands

```typescript
// Create task with multiple agents
const task = await commands.createTask(
  'Fix bug',
  'branch',
  'main',
  undefined,
  '/path/to/repo',
  'coder',
  [
    { providerId: 'anthropic', modelId: 'claude-sonnet-4' },
    { providerId: 'openai', modelId: 'gpt-4o' },
  ]
);

// CRUD operations
const tasks = await commands.getTasks();
const task = await commands.getTask(taskId);
await commands.updateTask(taskId, newName, newStatus);
await commands.deleteTask(taskId, deleteWorktrees);
```

#### Agent Commands

```typescript
// Agent management
await commands.addAgentToTask(taskId, modelId, providerId, agentType);
await commands.removeAgentFromTask(taskId, agentId, deleteWorktree);
await commands.updateAgentStatus(taskId, agentId, 'running');
await commands.acceptAgent(taskId, agentId);
await commands.cleanupUnacceptedAgents(taskId);

// OpenCode server management
const port = await commands.startAgentOpencode(taskId, agentId);
await commands.stopAgentOpencode(taskId, agentId);
const port = await commands.getAgentOpencodePort(taskId, agentId);
```

## Core Components

### `Header`

Application header with navigation tabs and settings.

```typescript
import { Header } from '@core/components';

<Header
  activeTab={activeTab}
  onTabChange={setActiveTab}
/>
```

### `SettingsDialog`

Application settings modal for theme, terminal, and editor preferences.

```typescript
import { SettingsDialog } from '@core/components';

<SettingsDialog
  open={settingsOpen}
  onOpenChange={setSettingsOpen}
/>
```

### `ThemeToggle`

Toggle between light, dark, and system themes.

```typescript
import { ThemeToggle } from '@core/components';

<ThemeToggle />
```

## Theming

The application supports a comprehensive theme system with multiple themes, each containing light and dark color schemes.

### Available Themes

| Theme | Description |
|-------|-------------|
| `aristar` | Playful and colorful with bold shadows (default) |
| `claude` | Warm, earthy tones inspired by Anthropic Claude |
| `vercel` | Clean and minimal monochrome design |
| `nature` | Calming forest greens and earthy tones |

### Theme Architecture

Theme CSS variables are injected dynamically via JavaScript, allowing instant theme switching without page reload.

```
┌─────────────────────────────────────────────────────────┐
│  Theme Definition (e.g., aristar.ts)                    │
│  ├── name: 'aristar'                                    │
│  ├── displayName: 'Aristar'                             │
│  ├── description: 'Playful and colorful...'             │
│  ├── light: { --background: 'hsl(...)', ... }           │
│  └── dark: { --background: 'hsl(...)', ... }            │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  useTheme() Hook                                        │
│  ├── Reads themeName and colorScheme from store         │
│  ├── Applies CSS variables to document.documentElement  │
│  ├── Toggles 'dark' class based on color scheme         │
│  └── Listens for system preference changes              │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  CSS (@theme inline in index.css)                       │
│  ├── Maps --background to --color-background            │
│  ├── Maps --primary to --color-primary                  │
│  └── Tailwind uses --color-* variables                  │
└─────────────────────────────────────────────────────────┘
```

### Using the Theme Hook

```typescript
import { useTheme } from '@core/hooks';

function MyComponent() {
  const {
    theme,              // Current ThemeDefinition
    themeName,          // Current theme name
    colorScheme,        // 'light' | 'dark' | 'system'
    effectiveColorScheme, // Resolved to 'light' | 'dark'
    themes,             // All available themes
    setThemeName,       // Change theme
    setColorScheme,     // Change color scheme
    toggleColorScheme,  // Toggle light/dark
  } = useTheme();

  return (
    <button onClick={() => setThemeName('claude')}>
      Switch to Claude theme
    </button>
  );
}
```

### Adding a New Theme

1. Create a new theme file in `src/modules/core/lib/themes/`:

```typescript
// src/modules/core/lib/themes/my-theme.ts
import type { ThemeDefinition } from '@/store/types';

export const myTheme: ThemeDefinition = {
  name: 'my-theme',
  displayName: 'My Theme',
  description: 'A custom theme description',
  light: {
    '--background': 'hsl(0 0% 100%)',
    '--foreground': 'hsl(0 0% 0%)',
    '--primary': 'hsl(220 90% 50%)',
    // ... all required CSS variables
  },
  dark: {
    '--background': 'hsl(0 0% 10%)',
    '--foreground': 'hsl(0 0% 100%)',
    '--primary': 'hsl(220 90% 60%)',
    // ... all required CSS variables
  },
};
```

2. Register the theme in `src/modules/core/lib/themes/index.ts`:

```typescript
import { myTheme } from './my-theme';

export const THEMES: ThemeDefinition[] = [
  aristarTheme,
  claudeTheme,
  vercelTheme,
  natureTheme,
  myTheme,  // Add your theme
];
```

### Required CSS Variables

Each theme must define the following CSS variables for both light and dark schemes:

**Colors:**
- `--background`, `--foreground`
- `--card`, `--card-foreground`
- `--popover`, `--popover-foreground`
- `--primary`, `--primary-foreground`
- `--secondary`, `--secondary-foreground`
- `--muted`, `--muted-foreground`
- `--accent`, `--accent-foreground`
- `--destructive`, `--destructive-foreground`
- `--border`, `--input`, `--ring`
- `--chart-1` through `--chart-5`
- `--sidebar`, `--sidebar-foreground`, `--sidebar-primary`, etc.

**Typography:**
- `--font-sans`, `--font-serif`, `--font-mono`

**Layout:**
- `--radius`, `--spacing`, `--tracking-normal`

**Shadows:**
- `--shadow-2xs` through `--shadow-2xl`

### Theme Persistence

Theme settings are persisted via Zustand's persist middleware to localStorage:
- `themeName`: The selected theme (e.g., 'aristar', 'claude')
- `colorScheme`: The color scheme preference ('light', 'dark', 'system')

## Adding New UI Components

To add a new shadcn/ui component:

1. Generate the component: `npx shadcn@latest add [component]`
2. Move from `src/components/ui/` to `src/modules/core/ui/`
3. Export from `src/modules/core/ui/index.ts`

## Error Handling

All Tauri commands throw on error. Use try/catch:

```typescript
try {
  await commands.createWorktree(...);
} catch (error) {
  console.error('Failed to create worktree:', error);
  // error is a string from the Rust backend
}
```
